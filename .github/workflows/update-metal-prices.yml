name: Update metal prices

on:
  schedule:
    # At 09:00, 12:00, and 16:00 UTC every day
    - cron: "0 9,12,16 * * *"
  workflow_dispatch: {}  # allows manual run from the Actions tab

permissions:
  contents: write

jobs:
  update-metal-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch prices from GoldAPI and write metal.json
        env:
          GOLDAPI_KEY: ${{ secrets.GOLDAPI_KEY }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          const apiKey = process.env.GOLDAPI_KEY;
          const goldUrl = "https://www.goldapi.io/api/XAU/GBP";
          const silverUrl = "https://www.goldapi.io/api/XAG/GBP";

          function getJson(url) {
            return new Promise((resolve, reject) => {
              const req = https.request(url, {
                method: 'GET',
                headers: {
                  'x-access-token': apiKey,
                  'Content-Type': 'application/json'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
              });
              req.on('error', reject);
              req.end();
            });
          }

          (async () => {
            try {
              const [gold, silver] = await Promise.all([
                getJson(goldUrl),
                getJson(silverUrl)
              ]);

              if (typeof gold.price !== 'number' || typeof silver.price !== 'number') {
                console.error("Invalid GoldAPI response", gold, silver);
                process.exit(1);
              }

              const payload = {
                gold_per_oz: gold.price,
                silver_per_oz: silver.price,
                updated: new Date().toISOString()
              };

              fs.writeFileSync('metal.json', JSON.stringify(payload, null, 2));
              console.log("Updated metal.json:", payload);
            } catch (err) {
              console.error("Error updating metal.json:", err);
              process.exit(1);
            }
          })();
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metal.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update metal prices"
            git push
          fi
