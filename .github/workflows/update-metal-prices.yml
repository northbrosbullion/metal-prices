name: Update metal prices

on:
  schedule:
    - cron: "0 9,12,16 * * 1-5"  # 09:00, 12:00, 16:00 UTC
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  update-metal-json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch prices (try GOLDAPI_KEY then GOLDAPI_KEY_2)
        env:
          KEY1: ${{ secrets.GOLDAPI_KEY }}
          KEY2: ${{ secrets.GOLDAPI_KEY_2 }}
        run: |
          node << 'EOF'
          const fs = require('fs');
          const https = require('https');

          const GOLD_URL = "https://www.goldapi.io/api/XAU/GBP";
          const SILVER_URL = "https://www.goldapi.io/api/XAG/GBP";

          function getJson(url, key) {
            return new Promise((resolve, reject) => {
              const req = https.request(url, {
                method: 'GET',
                headers: {
                  'x-access-token': key,
                  'Content-Type': 'application/json'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try { resolve(JSON.parse(data)); }
                  catch (e) { reject(e); }
                });
              });
              req.on('error', reject);
              req.end();
            });
          }

          async function fetchPricesWithBothKeys() {
            let gold, silver;

            // Try PRIMARY KEY first
            console.log("Trying main GoldAPI key...");
            try {
              gold   = await getJson(GOLD_URL,   process.env.KEY1);
              silver = await getJson(SILVER_URL, process.env.KEY1);
            } catch { gold = silver = null; }

            // If primary failed / invalid data â†’ try BACKUP KEY
            const valid = d => d && typeof d.price === "number";

            if (!valid(gold) || !valid(silver)) {
              console.log("Main key failed. Trying backup GoldAPI key...");
              gold   = await getJson(GOLD_URL,   process.env.KEY2);
              silver = await getJson(SILVER_URL, process.env.KEY2);
            }

            if (!valid(gold) || !valid(silver)) {
              console.error("Both API keys failed. Aborting.");
              process.exit(1);
            }

            return { gold, silver };
          }

          (async () => {
            try {
              const { gold, silver } = await fetchPricesWithBothKeys();

              const payload = {
                gold_per_oz: gold.price,
                silver_per_oz: silver.price,
                updated: new Date().toISOString()
              };

              fs.writeFileSync('metal.json', JSON.stringify(payload, null, 2));
              console.log("Updated metal.json:", payload);
            } catch (err) {
              console.error("Error:", err);
              process.exit(1);
            }
          })();
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metal.json
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update metal prices"
            git push
          fi
